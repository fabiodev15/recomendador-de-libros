<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Recommender - Preferencias</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="preferences-card">
            <h1>¿Qué te gusta leer?</h1>
            <p class="subtitle">Selecciona tus géneros favoritos</p>

            <div class="genres-grid" id="genresGrid">
                <!-- Genres will be added by JS -->
            </div>

            <div class="form-group">
                <label for="authors">Autores favoritos (opcional)</label>
                <input type="text" id="authors" placeholder="Ej: Gabriel García Márquez, J.K. Rowling">
                <small>Separa los autores con comas</small>
            </div>

            <div class="form-group">
                <label for="books">Libros favoritos (opcional)</label>
                <input type="text" id="books" placeholder="Ej: Cien años de soledad, Harry Potter">
                <small>Separa los libros con comas</small>
            </div>

            <button id="savePreferences" class="btn-primary">Continuar</button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        checkAuth();

        const genres = [
            'Ficción', 'Misterio', 'Ciencia Ficción', 'Fantasía', 'Romance',
            'Thriller', 'Biografía', 'Historia', 'Autoayuda', 'Negocios',
            'Poesía', 'Terror', 'Aventura', 'Filosofía', 'Ciencia'
        ];

        const selectedGenres = new Set();
        const genresGrid = document.getElementById('genresGrid');

        genres.forEach(genre => {
            const card = document.createElement('div');
            card.className = 'genre-card';
            card.textContent = genre;
            card.onclick = () => {
                if (selectedGenres.has(genre)) {
                    selectedGenres.delete(genre);
                    card.classList.remove('selected');
                } else {
                    selectedGenres.add(genre);
                    card.classList.add('selected');
                }
            };
            genresGrid.appendChild(card);
        });

        document.getElementById('savePreferences').addEventListener('click', async () => {
            if (selectedGenres.size === 0) {
                alert('Por favor selecciona al menos un género');
                return;
            }

            const authorsInput = document.getElementById('authors').value;
            const authors = authorsInput ? authorsInput.split(',').map(a => a.trim()).filter(a => a) : [];

            const booksInput = document.getElementById('books').value;
            const books = booksInput ? booksInput.split(',').map(b => b.trim()).filter(b => b) : [];

            try {
                const response = await fetch('http://localhost:3000/users/preferences', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        favorite_genres: Array.from(selectedGenres),
                        favorite_authors: authors,
                        favorite_books: books
                    })
                });

                if (response.ok) {
                    window.location.href = 'recommendations.html';
                } else {
                    alert('Error al guardar preferencias');
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        });
    </script>
</body>

</html>